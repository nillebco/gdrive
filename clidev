#!/bin/bash
set -e

# Use podman if available, otherwise docker
if command -v podman &>/dev/null; then
    CONTAINER_CMD="podman"
else
    CONTAINER_CMD="docker"
fi

set_impl_vars() {
    case "$1" in
        nodejs|node|js)
            IMAGE_NAME="gdrive-nodejs"
            DOCKERFILE="nodejs/Dockerfile"
            ;;
        python|py)
            IMAGE_NAME="gdrive-python"
            DOCKERFILE="python/Dockerfile"
            ;;
        *)
            echo "Usage: $0 build [nodejs|python]" >&2
            echo "   or: $0 [nodejs|python]" >&2
            exit 1
            ;;
    esac
}

do_build() {
    local impl="${1:-nodejs}"
    set_impl_vars "$impl"
    echo "Building ${IMAGE_NAME}..."
    "${CONTAINER_CMD}" build --label "org.opencontainers.image.ref.name=$IMAGE_NAME:latest" -f "${DOCKERFILE}" -t "${IMAGE_NAME}:latest" .
}

do_run() {
    local impl="$1"
    set_impl_vars "$impl"
    do_build "$impl"
    echo "Starting ${IMAGE_NAME}..."
    fnox exec "${CONTAINER_CMD}" run -d \
        --network services-network \
        --name gdrive \
        --restart=always \
        -p 8080:8080 \
        --env-file .env \
        "${IMAGE_NAME}:latest"
    echo "Container 'gdrive' started successfully."
}

do_serve() {
    local port="${1:-8080}"
    echo "Starting HTTP server on port ${port}..."
    echo "Server will be available at http://localhost:${port}"
    
    # Open browser after a short delay
    (sleep 1 && open "http://localhost:${port}") &
    
    # Start HTTP server in web directory
    cd web && python3 -m http.server "${port}"
}

# Parse: ./clidev build [nodejs|python]  (no .env) or ./clidev [nodejs|python]  (needs .env)
case "${1:-nodejs}" in
    build)
        do_build "${2:-nodejs}"
        ;;
    nodejs|node|js|python|py)
        source .env
        do_run "$1"
        ;;
    serve|web)
        do_serve "${2:-8080}"
        ;;
    *)
        echo "Usage: $0 build [nodejs|python]" >&2
        echo "   or: $0 [nodejs|python]" >&2
        echo "   or: $0 serve [port]" >&2
        exit 1
        ;;
esac
